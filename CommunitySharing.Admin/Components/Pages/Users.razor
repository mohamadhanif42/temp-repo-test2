@page "/users"
@using CommunitySharing.Admin.Models
@inject AdminApiService Api
@inject NavigationManager Nav

<h3>Users</h3>
<button class="btn btn-secondary mb-2" @onclick="Logout">Logout</button>
<button class="btn btn-primary mb-2 ms-2" @onclick="Reload">Reload</button>

@if (users == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table">
        <thead><tr><th>Email</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead>
        <tbody>
            @foreach (var u in users)
            {
                <tr>
                    <td>@u.Email</td>
                    <td>@u.Role</td>
                    <td>@(u.CreatedAt?.ToString("yyyy-MM-dd HH:mm") ?? "N/A")</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary"
                                @onclick="@(() => SetRole(u.Id, "Admin"))">
                            Set Admin
                        </button>

                        <button class="btn btn-sm btn-outline-danger ms-2"
                                @onclick="@(() => DeleteUser(u.Id))">
                            Delete
                        </button>

                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    List<AdminApiService.UserDto>? users;

    protected override async Task OnInitializedAsync()
    {
        var token = await Api.GetSavedTokenAsync();
        if (string.IsNullOrEmpty(token)) { Nav.NavigateTo("/login"); return; }
        await Reload();
    }

    async Task Reload()
    {
        users = await Api.GetUsersAsync();
    }

    async Task SetRole(int id, string role)
    {
        var ok = await Api.SetUserRoleAsync(id, role);
        if (ok) await Reload();
    }

    async Task DeleteUser(int id)
    {
        var ok = await Api.DeleteUserAsync(id);
        if (ok) await Reload();
    }

    async Task Logout()
    {
        await Api.ClearTokenAsync();
        Nav.NavigateTo("/login", forceLoad: true);
    }
}
