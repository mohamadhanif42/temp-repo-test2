@page "/login"
@inject AdminApiService Api
@inject NavigationManager Nav

<h3>Admin Login</h3>

<div class="mb-3">
    <label>Email</label>
    <input class="form-control" @bind="email" />
</div>
<div class="mb-3">
    <label>Password</label>
    <input type="password" class="form-control" @bind="password" />
</div>

<button class="btn btn-primary" @onclick="HandleLogin">Login</button>

@if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger mt-2">@error</div>
}

@code {
    string email = "";
    string password = "";
    string error = "";

    protected override async Task OnInitializedAsync()
    {
        // if token exists, go to inventory
        var token = await Api.GetSavedTokenAsync();
        if (!string.IsNullOrEmpty(token))
        {
            Nav.NavigateTo("/inventory");
        }
    }

    async Task HandleLogin()
    {
        error = "";
        var (ok, idToken, err) = await Api.FirebaseSignInAsync(email, password);
        if (!ok || string.IsNullOrEmpty(idToken))
        {
            error = "Firebase sign-in failed: " + err;
            return;
        }

        var (exOk, appToken, exErr) = await Api.ExchangeIdTokenAsync(idToken);
        if (!exOk || string.IsNullOrEmpty(appToken))
        {
            error = "Exchange failed: " + exErr;
            return;
        }

        Nav.NavigateTo("/inventory");
    }
}
